#!/usr/bin/env node

/**
 * –°–∫—Ä–∏–ø—Ç –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ Quote Editor –≤ Shadow DOM –≤–µ—Ä—Å–∏—é
 *
 * –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
 * node convert-to-shadow.js input.html output.js
 */

const fs = require('fs');
const path = require('path');

class QuoteEditorConverter {
    constructor(inputFile, outputFile) {
        this.inputFile = inputFile;
        this.outputFile = outputFile;
        this.replacements = [];
    }

    /**
     * –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
     */
    convert() {
        console.log('üîÑ Starting conversion...');
        console.log(`üìÑ Input: ${this.inputFile}`);
        console.log(`üìù Output: ${this.outputFile}`);

        // –ß–∏—Ç–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª
        let content = fs.readFileSync(this.inputFile, 'utf-8');

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Å–µ –∑–∞–º–µ–Ω—ã
        content = this.replaceSelectors(content);
        content = this.replaceEventListeners(content);
        content = this.wrapInShadowDOM(content);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        fs.writeFileSync(this.outputFile, content);

        console.log('‚úÖ Conversion completed!');
        console.log(`üìä Replacements made: ${this.replacements.length}`);

        // –í—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        this.printStatistics();
    }

    /**
     * –ó–∞–º–µ–Ω–∞ –≤—Å–µ—Ö —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤ –Ω–∞ Shadow DOM –≤–µ—Ä—Å–∏–∏
     */
    replaceSelectors(content) {
        const patterns = [
            // document.getElementById -> QE.get
            {
                pattern: /document\.getElementById\(['"`]([^'"`]+)['"`]\)/g,
                replacement: 'QE.get(\'$1\')',
                description: 'document.getElementById -> QE.get'
            },
            // document.querySelector -> QE.qs
            {
                pattern: /document\.querySelector\((['"`][^'"`]+['"`])\)/g,
                replacement: 'QE.qs($1)',
                description: 'document.querySelector -> QE.qs'
            },
            // document.querySelectorAll -> QE.qsAll
            {
                pattern: /document\.querySelectorAll\((['"`][^'"`]+['"`])\)/g,
                replacement: 'QE.qsAll($1)',
                description: 'document.querySelectorAll -> QE.qsAll'
            },
            // QE.get('id') –≤–º–µ—Å—Ç–æ QE.get('id')
            {
                pattern: /QE\.get\(['"`]([^'"`]+)['"`]\)/g,
                replacement: 'QE.get(\'$1\')',
                description: 'Normalize QE.get quotes'
            }
        ];

        patterns.forEach(({ pattern, replacement, description }) => {
            const matches = content.match(pattern);
            if (matches) {
                content = content.replace(pattern, replacement);
                this.replacements.push({
                    type: description,
                    count: matches.length
                });
            }
        });

        return content;
    }

    /**
     * –ó–∞–º–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –Ω–∞ document
     */
    replaceEventListeners(content) {
        // document.addEventListener -> shadowRoot.addEventListener
        // –ù–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (paste, resize –∏ —Ç.–¥.) –Ω–∞ document

        const globalEvents = ['paste', 'resize', 'scroll', 'keydown', 'keyup'];

        // –°–æ–∑–¥–∞–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ù–ï –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
        const nonGlobalPattern = new RegExp(
            `document\\.addEventListener\\(['"\`]((?!${globalEvents.join('|')})[^'"\`]+)['"\`]`,
            'g'
        );

        const matches = content.match(nonGlobalPattern);
        if (matches) {
            content = content.replace(
                nonGlobalPattern,
                'shadowRoot.addEventListener(\'$1\''
            );

            this.replacements.push({
                type: 'document.addEventListener -> shadowRoot.addEventListener',
                count: matches.length
            });
        }

        return content;
    }

    /**
     * –û–±–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ Shadow DOM —Å—Ç—Ä—É–∫—Ç—É—Ä—É
     */
    wrapInShadowDOM(content) {
        const wrapper = `
/**
 * Quote Editor - Shadow DOM Isolated Version
 * Auto-generated by convert-to-shadow.js
 */

(function() {
    'use strict';

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Shadow DOM
    const container = document.getElementById('isolated-quote-editor');
    if (!container) {
        console.error('‚ùå Container #isolated-quote-editor not found');
        return;
    }

    const shadowRoot = container.attachShadow({ mode: 'open' });

    // –í—Å—Ç–∞–≤–∫–∞ —Å—Ç–∏–ª–µ–π –∏ HTML
    // TODO: –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏–ª–∏ –≤—Å—Ç—Ä–æ–∏—Ç—å

    shadowRoot.innerHTML = \`
        <style>
            /* –°—Ç–∏–ª–∏ –±—É–¥—É—Ç –∑–¥–µ—Å—å */
        </style>

        <div class="main-ctr">
            <!-- HTML –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
        </div>
    \`;

    // ============= –ù–ê–ß–ê–õ–û –ö–û–ù–í–ï–†–¢–ò–†–û–í–ê–ù–ù–û–ì–û –ö–û–î–ê =============

${content}

    // ============= –ö–û–ù–ï–¶ –ö–û–ù–í–ï–†–¢–ò–†–û–í–ê–ù–ù–û–ì–û –ö–û–î–ê =============

    // –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    window.QuoteEditorInstance = {
        shadowRoot: shadowRoot,
        QE: QE,
        generateQuoteImage: function() {
            return QE.get('qcanvas');
        }
    };

})();
`;

        return wrapper;
    }

    /**
     * –í—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–º–µ–Ω
     */
    printStatistics() {
        console.log('\nüìä Conversion Statistics:');
        console.log('‚îÄ'.repeat(60));

        const grouped = this.replacements.reduce((acc, item) => {
            if (!acc[item.type]) {
                acc[item.type] = 0;
            }
            acc[item.type] += item.count;
            return acc;
        }, {});

        Object.entries(grouped).forEach(([type, count]) => {
            console.log(`  ${type}: ${count}`);
        });

        console.log('‚îÄ'.repeat(60));
        console.log(`  Total replacements: ${this.replacements.reduce((sum, r) => sum + r.count, 0)}`);
    }
}

// –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞
if (require.main === module) {
    const args = process.argv.slice(2);

    if (args.length < 2) {
        console.log('Usage: node convert-to-shadow.js <input-file> <output-file>');
        console.log('Example: node convert-to-shadow.js original.html converted.js');
        process.exit(1);
    }

    const converter = new QuoteEditorConverter(args[0], args[1]);
    converter.convert();
}

module.exports = QuoteEditorConverter;
